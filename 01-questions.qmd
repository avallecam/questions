---
title: "Q&As"
format: html
editor: source
editor_options: 
  chunk_output_type: console
---

## Introduction

```
You are R software teacher specialising in outbreak analytics and epidemic modelling. Give your answer entirely as R code, including some brief comments explaining key parts of the code. Do not include the original question in your response. Begin your response with a commented line introducing the code.
```

```
NOT USED: Your can use packages from the tidyverse to manage data object.
```

## Q1: growth rate

Question: How to calculate the weekly growth rate of an outbreak? 

Conditions: 
- Use the first list element from the Simulated Ebola outbreak ebola_sim_clean object from the outbreaks R package. 
- Use the "date of onset" column to calculate the weekly growth rate. 
- Keep the first 20 weeks of the period of the analysis.

### A1

```{r}
# Load required packages
library(outbreaks)
library(i2extras)
library(dplyr)

# Load the simulated Ebola outbreak data
data(ebola_sim_clean)

# Extract the first element of the list
linelist <- ebola_sim_clean[[1]]

# Convert the data to an incidence object
dat <- incidence(
  x = linelist, 
  date_index = "date_of_onset",
  interval = "week"
)

# Filter the dataset to keep the first 20 weeks. 
dat_filter <- dat[1:20,]

# Model the incidence
out <- fit_curve(dat_filter, model = "poisson", alpha = 0.05)

# Print the result
growth_rate(out)

# Plot the result
plot(out)
```

- The `outbreaks` package is loaded to access the simulated Ebola outbreak data.
- The `ebola_sim_clean` object from the package contains the simulated outbreak data.
- The `linelist` object contains the first list element from `ebola_sim_clean`.
- The `incidence()` function converts the data object `linelist` to an `incidence2` class object.
- The `date_of_onset` column is used in the `date_index` argument as the onset dates of the outbreak.
- The `"week"` text string is used to count number of cases per week interval to calculate the weekly growth rate.  
- The `incidence2` object provides observations arranged in descendant order with respect to the `date_index`.
- The number of weeks to consider is set to 20 and stored in the `dat_filter` object.
- The `fit_curve()` function fits a Poisson linear regression model to the epicurve in the `dat_filter` object with an alpha value of `0.05` to calculate the 95% confidence intervals.
- The `growth_rate()` function calculate the weekly growth/decay rate.
- The `plot()` function plot the fitted epicurve.

### Reference

- https://www.reconverse.org/i2extras/articles/fitting_epicurves.html

## Q2: susceptibility matrices

Question: How to create the susceptibility matrices for a scenario where the susceptibility varies between and within groups to use with the finalsize package?

This scenario assumes that, in the population, there is different susceptibility to the infection:

- between individuals of different age groups from 20% (infants) to 100% (65+), and
- within individuals of the same age group due the immunization effect of 25% to the 40% of each of the age groups.

Additionally, 10% of individuals in each of the age groups have 100% susceptibility, due to no immunization or not exposed to similar pathogens previously.

```{r}
demography_groups <- c("[0,5)", "[5,18)", "[18,40)", "[40,65)", "65+")
immunization_effect <- 0.25

# susceptibility matrix
susceptibility <- tibble(
  age_group = demography_groups,
  susceptible = c(1.0, 1.0, 1.0, 1.0, 1.0),
  unimmunised = c(0.2, 0.5, 0.6, 0.9, 1.0)
) %>%
  mutate(immunised = unimmunised * (1 - immunization_effect)) %>%
  column_to_rownames(var = "age_group") %>%
  as.matrix()

susceptibility

# demography-in-susceptibility matrix
p_susceptibility <- tibble(
  age_group = demography_groups,
  susceptible = c(0.1, 0.1, 0.1, 0.1, 0.1),
  immunised = c(0.4, 0.4, 0.4, 0.4, 0.4)
) %>%
  mutate(unimmunised = 1 - immunised - susceptible) %>%
  column_to_rownames(var = "age_group") %>%
  as.matrix()

p_susceptibility
```

### Reference

- https://epiverse-trace.github.io/finalsize/articles/susceptibility_matrices.html

## Q3: final size of an epidemic 

Question: How to calculate the final size of an epidemic accounting for heterogeneous social contact and homogeneous susceptibility in all age groups?

Conditions:

```{r}
library(finalsize)
library(socialmixr)
library(tidyverse)

# get UK polymod data
polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  polymod,
  countries = "United Kingdom",
  age.limits = c(0, 5, 18, 40, 65),
  symmetric = TRUE
)

# get the contact matrix and demography data
contact_matrix <- t(contact_data$matrix)

# scale the contact matrix so the largest eigenvalue is 1.0
# this is to ensure that the overall epidemic dynamics correctly reflect
# the assumed value of R0
contact_matrix_scaled <- contact_matrix / max(Re(eigen(contact_matrix)$values))

# Define population in each age group
demography_vector <- contact_data$demography$population
demography_groups <- contact_data$demography$age.group

# divide each row of the contact matrix by the corresponding demography
# this reflects the assumption that each individual in group {j} make contacts
# at random with individuals in group {i}
contact_matrix_random <- contact_matrix_scaled / demography_vector

# Define susceptibility of each group
# susceptibility matrix
susceptibility <- tibble(
  age_group = demography_groups,
  susceptible = c(0.8, 0.8, 0.8, 0.8, 0.8)
) %>%
  column_to_rownames(var = "age_group") %>%
  as.matrix()

susceptibility

# Assume uniform susceptibility within age groups
# demography-in-susceptibility matrix
p_susceptibility <- tibble(
  age_group = demography_groups,
  susceptible = c(1.0, 1.0, 1.0, 1.0, 1.0)
) %>%
  column_to_rownames(var = "age_group") %>%
  as.matrix()

p_susceptibility

# R0 of the disease
r0 <- 1.5 # assumed for pandemic influenza

# Calculate the proportion of individuals infected in each age group
final_size(
  r0 = r0,
  contact_matrix = contact_matrix_random,
  demography_vector = demography_vector,
  susceptibility = susceptibility,
  p_susceptibility = p_susceptibility
)
```

### Reference

- https://epiverse-trace.github.io/finalsize/articles/susceptibility_matrices.html
- https://epiverse-trace.github.io/finalsize/articles/varying_contacts.html


## Q2

Question: How to generate the effective reproductive number from the growth rate?

1. Is there a relationship between the growth rate and rt?

> i2extras and epitrix

```{r}

```

## Q3

2. How to know if an epidemic is under control? 

> epiestim

need to implement complementary intervention measures?

Can you estimate the time-varying reproduction number (Rt) of the outbreak?

```{r}
library(EpiEstim)

# Import data
data <- read.csv("outbreak_data.csv")

# Format data
data$date <- as.Date(data$date)
cases <- ts(data$cases, start = 1, frequency = 7)

# Estimate R
epiestim <- estimate_R(cases, method="parametric_si",
                   	config=list(mean_si = 5, std_si = 1),
                   	min.cases=10, maxLikelihood = FALSE)

```

## Q4

2. how can I took into account the reporting delays for the rt?

> https://mrc-ide.github.io/EpiEstim/articles/alternative_software.html

```{r}

```

## Q5

1. Can you develop a predictive model to forecast the future trajectory of the outbreak?

> projections
> bpmodels

how is the outbreak likely to develop over the next weeks?
what are the forecasted number of cases over next weeks?
what are the hospital bed requirements for next weeks?

```{r}

```

## Q6

3. superspreading event? compare the population r0 and the individual r0, dispersion parameter

> epicontacts
> bpmodels

> https://community.appliedepi.org/t/estimating-the-degree-of-super-spreading-from-transmission-chain-data/103

```{r}

```

## Q7

Question: How to extract a epiparamenter

How to convert from statistic to distrubution

How to convert from distribution to statistic

## Q7

2. In which scenarios the epidist object is useful? when to use a report summary statistic vs a dsitribution parameter

> epiparameter

```{r}

```


## Q9

2. What steps can I follow to create a reproducible report to quantify the time varying transmission during a real-time outbreak evaluation?

> episoap

```{r}

```

## Q2

Question: How to calculate a delay-corrected case fatality ratio?

```{r}

```

## draft

1. Can you get the linelist and contact data from the outbreaks?
2. Can you use the covid regional data from the covidregional package?
3. Pick data before the peak of cases?
